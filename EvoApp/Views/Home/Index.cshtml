@using EvoApp.Models
@using EvoApp.Services
@inject LandMap landMap

@{
	ViewBag.Title = "Index";
}
<div id="land-field">
	@foreach (var landTile in landMap.LandTiles)
	{
		<div data-land-x="@landTile.Coordinates.landX" data-land-y="@landTile.Coordinates.landY" class="land-tile @landTile.LandType">
			@for (int y = 0; y < landTile.TileGrid.GetLength(0); y++)
			{
				@for (int x = 0; x < landTile.TileGrid.GetLength(1); x++)
				{
					<div data-tile-x="@x" data-tile-y="@y">@landTile.TileGrid[y, x]?.Name</div>
				}
			}
		</div>
	}
</div>

@section lib {
	<script src="lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
}
@section style {
	<link href="~/styles/home/index.css" rel="stylesheet" />
}

@section script {
	<script>
		const hubConnection = new signalR.HubConnectionBuilder().withUrl("/land").build();

		[...document.getElementsByClassName("land-tile")]
			.forEach(land => land.addEventListener("click", (ev) => {
				const { landX, landY } = ev.target.parentNode.dataset;
				const { tileX, tileY } = ev.target.dataset;
				hubConnection.invoke("PlaceItem",
					1, parseInt(landX, 10), parseInt(landY), parseInt(tileX, 10), parseInt(tileY, 10));
			}))

		hubConnection.on("PlacedItem", item => {
			document
				.querySelector(`[data-land-x="${item.landX}"][data-land-y="${item.landY}"]`)
				.querySelector(`[data-tile-x="${item.tileX}"][data-tile-y="${item.tileY}"]`)
				.textContent = item.itemId;
		
		});

		hubConnection.start().then(() => { console.log("Socket connected!") });

	</script>
}